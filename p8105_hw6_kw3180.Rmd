---
title: "p8105_hw6_kw3180"
author: "Kino Watanabe"
date: "2025-11-28"
output: github_document
---

```{r, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 2

### Load the data

```{r}
library(modelr)
library(p8105.datasets)
data("weather_df") 

weather_df <- weather_df |> 
  filter(name == "CentralPark_NY")
```
What do the distribution of variables prcp and tmin look like?

```{r}
weather_df |> 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_point() 

weather_df |> 
  ggplot(aes(x = prcp, y = tmax)) + 
  geom_point() 
```

### Let's do bootstrapping

```{r}
set.seed(1)

bootstrap_results = 
  weather_df |> 
  bootstrap(n = 5000) |> 
  mutate(
    df = map(strap, as_tibble),
    fits = map(df, \(df) lm(tmax ~ tmin + prcp, data = df)),
    coefs = map(fits, broom::tidy),
    rsquare = map(fits, broom::glance)
  ) |> 
  select(.id, coefs, rsquare) 


coefs_tibble <- bootstrap_results |> 
  unnest(coefs) |> 
  select(.id, term, estimate) |> 
  pivot_wider(
    names_from = term, 
    values_from = estimate) |> 
  mutate(beta_slope = tmin / prcp)


rsquare_tibble <- bootstrap_results |> 
  unnest(rsquare) |> 
  select(.id, r.squared, adj.r.squared)

bootstrap_results_merged <- 
  left_join(coefs_tibble, rsquare_tibble, by = ".id")


bootstrap_results_merged
```

### Plot the distribution after bootstrapping

```{r}
# r² distribution
rsquare_plot <- bootstrap_results_merged |> 
  ggplot(aes(x = r.squared)) +
  geom_density() +
  labs(
    x = "R-square hat estimates",
    y = "Density",
    title = "Bootstrap Distribution of r² hat")

rsquare_plot

# β¹ ÷ β² distribution
slope_plot <- bootstrap_results_merged |> 
  ggplot(aes(x = beta_slope)) +
  geom_density() +
  labs(
    x = "β1 hat/ β2 hat estimates",
    y = "Density",
    title = "Bootstrap Distribution of β1 hat/ β2 hat")

slope_plot
```

* The r-square is generally normally distributed after bootstrapping, but the distribution of r-squares are still slightly left skewed.
* The 95% CI for the proportion of variance in Central Park's tmax that is explained by predictors tmin and prcp is between 0.89 and 0.93.

* The distribution after bootstrapping for β1 hat/ β2 hat is extremely skewed to the left, and the wide distribution is reflected in its large 95% CI = (-5616.45, 4586.92). his occurs because the beta coefficient for prcp is close to 0, while the beta coefficient for tmin is close to 1. Small differences in beta 2 (prcp) lead to large changes in the slope ratio, making the estimate unstable. Additionally, precipitation shows outliers and does not appear to have a meaningful linear association with tmax, further contributing to variability in its estimated coefficient and instability in the ratio.


### 95% CI
```{r}
bootstrap_results_merged |> 
  summarize(
    r2_ci_lower = quantile(r.squared, 0.025),
    r2_ci_upper = quantile(r.squared, 0.975),
    beta_ci_lower = quantile(beta_slope, 0.025),
    beta_ci_upper = quantile(beta_slope, 0.975)
  )
```

# Problem 3


```{r}
library(modelr)
```

```{r}
bwt_df <-
  read_csv("birthweight.csv", na = c("NA", ".", "")) |> 
  janitor::clean_names() |> 
   rename(
    baby_sex = babysex,
    baby_head_cm = bhead,
    baby_length_cm = blength,
    bwt_grams = bwt,
    mom_wt_lb = delwt,
    fam_income_hundreds = fincome,
    father_race = frace,
    gestational_age_weeks = gaweeks,
    malform = malform,
    menarche = menarche,
    mom_height_in = mheight,
    mom_age = momage,
    mother_race = mrace,
    parity = parity,
    previous_lbw = pnumlbw,
    previous_sga = pnumsga,
    mom_pp_bmi = ppbmi,
    mom_pp_wt_lb = ppwt,
    mom_smoke_per_day = smoken,
    mom_wt_gain_lb = wtgain
  ) |> 
  mutate(
    baby_sex = case_match(
                baby_sex, 
                1 ~ "Male",
                2 ~ "Female"
              ),
    baby_sex = factor(baby_sex, levels = c("Male", "Female")),
    mother_race = case_match(mother_race,
                             1 ~ "White", 
                             2 ~ "Black", 
                             3 ~ "Asian", 
                             4 ~ "Puerto Rican", 
                             8 ~ "Other"
                             ),
    mother_race = factor(mother_race, levels = c("White", "Black", "Asian", 
                                                 "Puerto Rican", "Other")),
    father_race = case_match(father_race,
                              1 ~ "White",
                              2 ~ "Black",
                              3 ~ "Asian",
                              4 ~ "Puerto Rican",
                              8 ~ "Other",
                              9 ~ "Unknown"
                              ),
    
     father_race = factor(father_race, levels = c("White", "Black", "Asian",
                                                  "Puerto Rican", "Other",
                                                  "Unknown")),
     malform = case_match(malform,
                          0 ~ "Absent",
                          1 ~ "Present"
                          ),
     malform = factor(malform, levels = c("Absent", "Present"))
    )

bwt_df = 
  bwt_df |> 
  mutate(id = row_number())

# Quick check for missing values
na_counts <- bwt_df |> 
  summarise_all(~ sum(is.na(.)))

print(na_counts)

```

I am aiming for a theory-driven hypothesis proposal based on published literature. Based on "The determinants of birth weight," they asserted, "The results show that the sex of the baby, parity, maternal smoking during the pregnancy, maternal height, weight, marital status, and race, and gestation (after allowing for the foregoing characteristics) were all important and significant factors." Thus, I will propose a model with `baby_sex`, `parity`, `mom_smoke_per_day`, `mom_height_in`, `mom_wt_gain_lb`, and `mother_race` as predictors to birthweight.

[The determinants of birth weight](https://pubmed.ncbi.nlm.nih.gov/7114129/)


### Explore data

```{r}
bwt_df |> 
  ggplot(aes(x = parity, y = bwt_grams)) + 
  geom_point()
```

* There is so little variation in `parity` that it would not be a useful predictor. I will remove this from the model.

Hypothesized model and 2 homework-proposed models
```{r}

hypothesis_fit = lm(bwt_grams ~ baby_sex + mom_smoke_per_day + mom_height_in + mom_wt_gain_lb + mother_race, data = bwt_df)

hypothesis_fit |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

fit = lm(bwt_grams ~ baby_length_cm + gestational_age_weeks, data = bwt_df)

fit |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

fit_interactions =
  lm(bwt_grams ~ baby_head_cm * baby_length_cm * baby_sex, data = bwt_df)

fit_interactions |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)
```

### Residual Diagnostics for hypothesized model

Look at residuals for hypothesized model.

```{r}
bwt_df |> 
  modelr::add_residuals(hypothesis_fit) |> 
  modelr::add_predictions(hypothesis_fit) |> 
  ggplot(aes(x = resid)) + 
  geom_histogram() +
  labs(title = "Histogram of Residuals for Hypothesis Model", 
       x = "Residuals", 
       y = "Count")


bwt_df |> 
  modelr::add_predictions(hypothesis_fit) |> 
  modelr::add_residuals(hypothesis_fit) |> 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(x = "Fitted values", 
       y = "Residuals", 
       title = "Residuals vs Fitted Values for Hypothesis Model")


```

* The first plot shows that the residuals for the hypothesized model is generally normally distributed, symmetric, and centered at 0. There is a little skewing on the left-hand size.
* The "Residuals vs Fitted Values for Hypothesis Model" is the diagnostic for linearity and homoscedasticity. The roughly oval and symmetric shape reflects that there’s more variability in residuals at certain fitted values (often at higher birthweights). The model’s linearity assumption holds, as residuals don’t show a clear trend.

### Train/test data for CV

```{r}
set.seed(1)

cv_df = 
  crossv_mc(bwt_df, n = 100) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_df <- cv_df |> 
  mutate(
   hypothesis_fit = map(train, \(df) lm(bwt_grams ~ baby_sex + mom_smoke_per_day + mom_height_in + mom_wt_gain_lb + mother_race, data = df)),
    fit = map(train, \(df) lm(bwt_grams ~ baby_length_cm + gestational_age_weeks, data = df)),
    fit_interactions = map(train, \(df) lm(bwt_grams ~ baby_head_cm * baby_length_cm * baby_sex, data = df))
  )|> 
  mutate(
    rmse_hypothesis = map2_dbl(hypothesis_fit, test, rmse),
    rmse_fit = map2_dbl(fit, test, rmse),
    rmse_fit_interactions = map2_dbl(fit_interactions, test, rmse)
  )
```

```{r}
cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) |> 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin()
```

